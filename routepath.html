<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.2.css" />
        <script src="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.2.js"></script>
        <style>
            body { margin: 0; padding: 0; }

            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
            }

        </style>
    </head>
    <body>
        <div id="map"></div>

        <script>
            // Commenting out existing TrimbleMaps setup code as per instructions.
            /*
            TrimbleMaps.setAPIKey('sample');
            const map = new TrimbleMaps.Map({
                container: 'map',
                style: TrimbleMaps.Common.Style.TRANSPORTATION,
                center: new TrimbleMaps.LngLat(-74.566234, 40.49944),
                zoom: 8
            });
            const myRoute = new TrimbleMaps.Route({
                routeId: 'myRoute',
                stops: [
                    new TrimbleMaps.LngLat(-74.566234, 40.49944),
                    new TrimbleMaps.LngLat(-74.528512, 40.386680),
                    new TrimbleMaps.LngLat(-74.629749, 40.26118)
                ],
                showStops: false
            });

            map.on('load', function() {
                myRoute.addTo(map);
            });
            */
        </script>

        <script>
            TrimbleMaps.setAPIKey('sample'); // Activate API Key
            let fetchedRouteCoordinates; // Global variable to store coordinates

            async function loadRouteData() {
                const apiUrl = 'https://pcmiler.alk.com/APIs/REST/v1.0/service.svc/route/routePath?dataset=Current';
                const headers = {
                    'Authorization': 'token=dqlyate87c756745hvm7mzztugkhr2gg',
                    'Content-Type': 'application/json',
                    'Accept': '*/*'
                    // 'X-Requested-With': 'XMLHttpRequest', // Removed as per instructions (or not specified for POST)
                    // 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36' // Kept for now, often useful
                };

                const requestBody = {
                    "Route": {
                        "RouteId": "1",
                        "Stops": [
                            {"Coords": {"Lat": "40.323605", "Lon": "-104.980339"}},
                            {
                                "Coords": {"Lat": "40.246357", "Lon": "-104.975851"},
                                "Address": {"StreetAddress": "4194 Route 36", "City": "Platteville", "State": "CO", "Zip": "80651", "County": "", "Country": "US"},
                                "Costs": {"CostOfStop": 0, "HoursPerStop": 0, "Loaded": true, "OnDuty": true, "UseOrigin": false},
                                "PlaceId": "1xoXPsMAQsu0aoqLNE7BQNIg"
                            }
                        ],
                        "ExtendedOptions": {"UseTraffic": false},
                        "Options": {
                            "VehicleType": 0,
                            "RoutingType": 0,
                            "HubRouting": false,
                            "TollDiscourage": false,
                            "TollRoads": 3,
                            "AFSetIDs": [],
                            "BordersOpen": true,
                            "HighwayOnly": false,
                            "HazMatType": 0,
                            "DistanceUnits": 0,
                            "TruckCfg": {
                                "LCV": false,
                                "Units": 0,
                                "Height": "13'6\"",
                                "Length": "48'0\"",
                                "Width": "96\"",
                                "Weight": 80000,
                                "Axles": 5,
                                "MaxWeightPerAxleGroup": 34000
                            },
                            "FerryDiscourage": false,
                            "SideOfStreetAdherence": 0,
                            "UseAvoidsAndFavors": false,
                            "UseSites": true,
                            "IncludeTrimblePlaceIDs": true,
                            "ClassOverrides": 0
                        }
                    }
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                    if (!response.ok) {
                        console.error('Error fetching route data:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('Error details:', errorText);
                        return;
                    }
                    const jsonData = await response.json();
                    console.log('Raw API Response:', jsonData); // Log raw response

                    if (jsonData && jsonData.geometry && jsonData.geometry.coordinates && jsonData.geometry.coordinates.length > 0) {
                        const routeCoordinates = jsonData.geometry.coordinates[0];
                        console.log('Extracted Route Coordinates:', routeCoordinates);
                        fetchedRouteCoordinates = routeCoordinates; // Store in global variable

                        if (fetchedRouteCoordinates && fetchedRouteCoordinates.length > 0) {
                            const firstCoord = fetchedRouteCoordinates[0];
                            const map = new TrimbleMaps.Map({
                                container: 'map',
                                style: TrimbleMaps.Common.Style.TRANSPORTATION,
                                center: new TrimbleMaps.LngLat(firstCoord[0], firstCoord[1]),
                                zoom: 10 // Adjusted zoom for better initial view
                            });

                            const routeStops = fetchedRouteCoordinates.map(coord => new TrimbleMaps.LngLat(coord[0], coord[1]));

                            const myRoute = new TrimbleMaps.Route({
                                routeId: 'myDynamicRoute',
                                stops: routeStops,
                                showStops: false
                            });

                            map.on('load', function() {
                                myRoute.addTo(map);
                                console.log('Route added to map.');
                            });
                        } else {
                            console.error('No coordinates available to initialize map.');
                        }
                    } else {
                        console.error('Could not extract coordinates from response:', jsonData);
                    }
                } catch (error) {
                    console.error('Failed to fetch or parse route data:', error);
                }
            }

            loadRouteData();
        </script>
    </body>
</html>
