<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.2.css" />
        <script src="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.2.js"></script>
        <style>
            body { margin: 0; padding: 0; }

            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
            }

        </style>
    </head>
    <body>
        <div id="map"></div>

        <script>
            // Commenting out existing TrimbleMaps setup code as per instructions.
            /*
            TrimbleMaps.setAPIKey('sample');
            const map = new TrimbleMaps.Map({
                container: 'map',
                style: TrimbleMaps.Common.Style.TRANSPORTATION,
                center: new TrimbleMaps.LngLat(-74.566234, 40.49944),
                zoom: 8
            });
            const myRoute = new TrimbleMaps.Route({
                routeId: 'myRoute',
                stops: [
                    new TrimbleMaps.LngLat(-74.566234, 40.49944),
                    new TrimbleMaps.LngLat(-74.528512, 40.386680),
                    new TrimbleMaps.LngLat(-74.629749, 40.26118)
                ],
                showStops: false
            });

            map.on('load', function() {
                myRoute.addTo(map);
            });
            */
        </script>

        <script>
            TrimbleMaps.setAPIKey('sample'); // Activate API Key
            let fetchedRouteCoordinates; // Global variable to store coordinates

            async function loadRouteData() {
                const apiUrl = 'https://pcmiler.alk.com/APIs/REST/v1.0/service.svc/route/routePath?stops=-104.974608%2C40.247991%3B-104.867234%2C40.329796&vehType=0&routeType=0&hwyOnly=false&overrideClass=3&distUnits=0&avoidTolls=false&openBorders=true&overrideRestrict=false&hazMat=0&hubRouting=false&vehDimUnits=0&vehHeight=13%276%22&vehLength=56%270%22&vehWidth=102%22&vehWeight=80000&axles=3&LCV=false&dataset=Current&ferryDiscourage=false&sideOfStreetAdherence=0&useSites=false&includeplids=true';
                const headers = {
                    'Authorization': '1D6B42C5799EA143B45FC1320533ADFE|dqlyate87c756745hvm7mzztugkhr2gg|2013-01-24T06:02:03.004Z',
                    'X-Requested-With': 'XMLHttpRequest',
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36'
                };

                try {
                    const response = await fetch(apiUrl, { headers: headers });
                    if (!response.ok) {
                        console.error('Error fetching route data:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('Error details:', errorText);
                        return;
                    }
                    const jsonData = await response.json();
                    console.log('Raw API Response:', jsonData); // Log raw response

                    if (jsonData && jsonData.geometry && jsonData.geometry.coordinates && jsonData.geometry.coordinates.length > 0) {
                        const routeCoordinates = jsonData.geometry.coordinates[0];
                        console.log('Extracted Route Coordinates:', routeCoordinates);
                        fetchedRouteCoordinates = routeCoordinates; // Store in global variable

                        if (fetchedRouteCoordinates && fetchedRouteCoordinates.length > 0) {
                            const firstCoord = fetchedRouteCoordinates[0];
                            const map = new TrimbleMaps.Map({
                                container: 'map',
                                style: TrimbleMaps.Common.Style.TRANSPORTATION,
                                center: new TrimbleMaps.LngLat(firstCoord[0], firstCoord[1]),
                                zoom: 10 // Adjusted zoom for better initial view
                            });

                            const routeStops = fetchedRouteCoordinates.map(coord => new TrimbleMaps.LngLat(coord[0], coord[1]));

                            const myRoute = new TrimbleMaps.Route({
                                routeId: 'myDynamicRoute',
                                stops: routeStops,
                                showStops: false
                            });

                            map.on('load', function() {
                                myRoute.addTo(map);
                                console.log('Route added to map.');
                            });
                        } else {
                            console.error('No coordinates available to initialize map.');
                        }
                    } else {
                        console.error('Could not extract coordinates from response:', jsonData);
                    }
                } catch (error) {
                    console.error('Failed to fetch or parse route data:', error);
                }
            }

            loadRouteData();
        </script>
    </body>
</html>
